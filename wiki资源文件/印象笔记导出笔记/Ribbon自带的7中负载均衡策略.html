<html>
<head>
  <title>Evernote Export</title>
  <basefont face="微软雅黑" size="2" />
  <meta http-equiv="Content-Type" content="text/html;charset=utf-8" />
  <meta name="exporter-version" content="Evernote Windows/306729 (zh-CN, DDL); Windows/6.1.0 (Win64);"/>
  <style>
    body, td {
      font-family: 微软雅黑;
      font-size: 10pt;
    }
  </style>
</head>
<body>
<a name="2702"/>

<div>
<span><div style="margin: 0px 0px 16px; padding: 0px; box-sizing: border-box; font-size: 16px; text-align: justify; word-wrap: break-word; word-break: normal; letter-spacing: normal; orphans: 2; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; background-color: rgb(255, 255, 255);"><span style="box-sizing: border-box; font-size: 16px; word-wrap: break-word; word-break: normal; letter-spacing: normal; orphans: 2; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; color: rgb(79, 79, 79); font-family: -apple-system, &quot;SF UI Text&quot;, Arial, &quot;PingFang SC&quot;, &quot;Hiragino Sans GB&quot;, &quot;Microsoft YaHei&quot;, &quot;WenQuanYi Micro Hei&quot;, sans-serif, SimHei, SimSun; font-variant-caps: normal; font-variant-ligatures: normal; line-height: 26px;">Ribbon作为后端负载均衡器，比Nginx更注重的是承担并发而不是请求分发，可以直接感知后台动态变化来指定分发策略。</span></div><div style="margin: 0px 0px 16px; padding: 0px; box-sizing: border-box; font-size: 16px; text-align: justify; word-wrap: break-word; word-break: normal; letter-spacing: normal; orphans: 2; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; background-color: rgb(255, 255, 255);"><span style="box-sizing: border-box; font-size: 16px; word-wrap: break-word; word-break: normal; letter-spacing: normal; orphans: 2; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px;"><span style="color: rgb(79, 79, 79); font-family: -apple-system, &quot;SF UI Text&quot;, Arial, &quot;PingFang SC&quot;, &quot;Hiragino Sans GB&quot;, &quot;Microsoft YaHei&quot;, &quot;WenQuanYi Micro Hei&quot;, sans-serif, SimHei, SimSun; font-size: 16px; font-variant-caps: normal; font-variant-ligatures: normal; line-height: 26px; font-weight: bold;">Ribbon提供了7种负载均衡策略</span></span></div><div style="margin: 0px 0px 16px; padding: 0px; box-sizing: border-box; text-align: justify; word-wrap: break-word; word-break: normal; letter-spacing: normal; orphans: 2; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px;"><table style="border-collapse: collapse; min-width: 100%;"><colgroup><col style="width: 203px;"></col><col style="width: 642px;"></col><col style="width: 251px;"></col><col style="width: 594px;"></col></colgroup><tbody><tr><td style="padding: 8px; border: 1px solid rgb(204, 204, 204); width: 203px;"><div><span style="font-size: 12pt; font-variant-caps: normal; font-variant-ligatures: normal; line-height: 26px; color: rgb(79, 79, 79); font-family: -apple-system;">策略名</span></div></td><td style="padding: 8px; border: 1px solid rgb(204, 204, 204); width: 642px;"><div><span style="font-size: 12pt; font-variant-caps: normal; font-variant-ligatures: normal; line-height: 26px; color: rgb(79, 79, 79); font-family: -apple-system;">策略声明</span></div></td><td style="padding: 8px; border: 1px solid rgb(204, 204, 204); width: 251px;"><div><span style="font-size: 12pt; font-variant-caps: normal; font-variant-ligatures: normal; line-height: 26px; color: rgb(79, 79, 79); font-family: -apple-system;">策略描述</span></div></td><td style="padding: 8px; border: 1px solid rgb(204, 204, 204); width: 594px;"><div><span style="font-size: 12pt; font-variant-caps: normal; font-variant-ligatures: normal; line-height: 26px; color: rgb(79, 79, 79); font-family: -apple-system;">实现说明</span></div></td></tr><tr><td style="padding: 8px; border: 1px solid rgb(204, 204, 204); width: 203px;"><div><span style="font-size: 12pt; font-variant-caps: normal; font-variant-ligatures: normal; line-height: 26px; color: rgb(79, 79, 79); font-family: -apple-system;">BestAvailableRule</span></div></td><td style="padding: 8px; border: 1px solid rgb(204, 204, 204); width: 642px;"><div><span style="font-size: 12pt; font-variant-caps: normal; font-variant-ligatures: normal; line-height: 26px; color: rgb(79, 79, 79); font-family: -apple-system;">public class BestAvailableRule extends ClientConfigEnabledRoundRobinRule</span></div></td><td style="padding: 8px; border: 1px solid rgb(204, 204, 204); width: 251px;"><div><span style="font-size: 12pt; font-variant-caps: normal; font-variant-ligatures: normal; line-height: 26px; color: rgb(79, 79, 79); font-family: -apple-system;">选择一个最小的并发请求的server</span></div></td><td style="padding: 8px; border: 1px solid rgb(204, 204, 204); width: 594px;"><div><span style="font-size: 12pt; font-variant-caps: normal; font-variant-ligatures: normal; line-height: 26px; color: rgb(79, 79, 79); font-family: -apple-system;">逐个考察Server，如果Server被tripped了，则忽略，在选择其中ActiveRequestsCount最小的server</span></div></td></tr><tr><td style="padding: 8px; border: 1px solid rgb(204, 204, 204); width: 203px;"><div><span style="font-size: 12pt; font-variant-caps: normal; font-variant-ligatures: normal; line-height: 26px; color: rgb(79, 79, 79); font-family: -apple-system;">AvailabilityFilteringRule</span></div></td><td style="padding: 8px; border: 1px solid rgb(204, 204, 204); width: 642px;"><div><span style="font-size: 12pt; font-variant-caps: normal; font-variant-ligatures: normal; line-height: 26px; color: rgb(79, 79, 79); font-family: -apple-system;">public class AvailabilityFilteringRule extends PredicateBasedRule</span></div></td><td style="padding: 8px; border: 1px solid rgb(204, 204, 204); width: 251px;"><div><span style="font-size: 12pt; font-variant-caps: normal; font-variant-ligatures: normal; line-height: 26px; color: rgb(79, 79, 79); font-family: -apple-system;">过滤掉那些因为一直连接失败的被标记为circuit tripped的后端server，并过滤掉那些高并发的的后端server（active connections 超过配置的阈值）</span></div></td><td style="padding: 8px; border: 1px solid rgb(204, 204, 204); width: 594px;"><div><span style="font-size: 12pt; font-variant-caps: normal; font-variant-ligatures: normal; line-height: 26px; color: rgb(79, 79, 79); font-family: -apple-system;">使用一个AvailabilityPredicate来包含过滤server的逻辑，其实就就是检查status里记录的各个server的运行状态</span></div></td></tr><tr><td style="padding: 8px; border: 1px solid rgb(204, 204, 204); width: 203px;"><div><span style="font-size: 12pt; font-variant-caps: normal; font-variant-ligatures: normal; line-height: 26px; color: rgb(79, 79, 79); font-family: -apple-system;">WeightedResponseTimeRule</span></div></td><td style="padding: 8px; border: 1px solid rgb(204, 204, 204); width: 642px;"><div><span style="font-size: 12pt; font-variant-caps: normal; font-variant-ligatures: normal; line-height: 26px; color: rgb(79, 79, 79); font-family: -apple-system;">public class WeightedResponseTimeRule extends RoundRobinRule</span></div></td><td style="padding: 8px; border: 1px solid rgb(204, 204, 204); width: 251px;"><div><span style="font-size: 12pt; font-variant-caps: normal; font-variant-ligatures: normal; line-height: 26px; color: rgb(79, 79, 79); font-family: -apple-system;">根据响应时间分配一个weight，响应时间越长，weight越小，被选中的可能性越低。</span></div></td><td style="padding: 8px; border: 1px solid rgb(204, 204, 204); width: 594px;"><div><span style="font-size: 12pt; font-variant-caps: normal; font-variant-ligatures: normal; line-height: 26px; color: rgb(79, 79, 79); font-family: -apple-system;">一个后台线程定期的从status里面读取评价响应时间，为每个server计算一个weight。Weight的计算也比较简单responsetime 减去每个server自己平均的responsetime是server的权重。当刚开始运行，没有形成status时，使用roubine策略选择server。</span></div></td></tr><tr><td style="padding: 8px; border: 1px solid rgb(204, 204, 204); width: 203px;"><div><span style="font-size: 12pt; font-variant-caps: normal; font-variant-ligatures: normal; line-height: 26px; color: rgb(79, 79, 79); font-family: -apple-system;">RetryRule</span></div></td><td style="padding: 8px; border: 1px solid rgb(204, 204, 204); width: 642px;"><div><span style="font-size: 12pt; font-variant-caps: normal; font-variant-ligatures: normal; line-height: 26px; color: rgb(79, 79, 79); font-family: -apple-system;">public class RetryRule extends AbstractLoadBalancerRule</span></div></td><td style="padding: 8px; border: 1px solid rgb(204, 204, 204); width: 251px;"><div style="box-sizing: border-box; margin: 0px; padding: 0px;"><div><span style="font-variant-caps: normal; font-variant-ligatures: normal; line-height: 26px;">对选定的负载均衡策略机上重试机制。<br/></span></div></div><div><br/></div></td><td style="padding: 8px; border: 1px solid rgb(204, 204, 204); width: 594px;"><div><span style="font-size: 12pt; font-variant-caps: normal; font-variant-ligatures: normal; line-height: 26px; color: rgb(79, 79, 79); font-family: -apple-system;">在一个配置时间段内当选择server不成功，则一直尝试使用subRule的方式选择一个可用的server</span></div></td></tr><tr><td style="padding: 8px; border: 1px solid rgb(204, 204, 204); width: 203px;"><div><span style="font-size: 12pt; font-variant-caps: normal; font-variant-ligatures: normal; line-height: 26px; color: rgb(79, 79, 79); font-family: -apple-system;">RoundRobinRule</span></div></td><td style="padding: 8px; border: 1px solid rgb(204, 204, 204); width: 642px;"><div><span style="font-size: 12pt; font-variant-caps: normal; font-variant-ligatures: normal; line-height: 26px; color: rgb(79, 79, 79); font-family: -apple-system;">public class RoundRobinRule extends AbstractLoadBalancerRule</span></div></td><td style="padding: 8px; border: 1px solid rgb(204, 204, 204); width: 251px;"><div><span style="font-size: 12pt; font-variant-caps: normal; font-variant-ligatures: normal; line-height: 26px; color: rgb(79, 79, 79); font-family: -apple-system;">roundRobin方式轮询选择server</span></div></td><td style="padding: 8px; border: 1px solid rgb(204, 204, 204); width: 594px;"><div><span style="font-size: 12pt; font-variant-caps: normal; font-variant-ligatures: normal; line-height: 26px; color: rgb(79, 79, 79); font-family: -apple-system;">轮询index，选择index对应位置的server</span></div></td></tr><tr><td style="padding: 8px; border: 1px solid rgb(204, 204, 204); width: 203px;"><div><span style="font-size: 12pt; font-variant-caps: normal; font-variant-ligatures: normal; line-height: 26px; color: rgb(79, 79, 79); font-family: -apple-system;">RandomRule</span></div></td><td style="padding: 8px; border: 1px solid rgb(204, 204, 204); width: 642px;"><div><span style="font-size: 12pt; font-variant-caps: normal; font-variant-ligatures: normal; line-height: 26px; color: rgb(79, 79, 79); font-family: -apple-system;">public class RandomRule extends AbstractLoadBalancerRule</span></div></td><td style="padding: 8px; border: 1px solid rgb(204, 204, 204); width: 251px;"><div><span style="font-size: 12pt; font-variant-caps: normal; font-variant-ligatures: normal; line-height: 26px; color: rgb(79, 79, 79); font-family: -apple-system;">随机选择一个server</span></div></td><td style="padding: 8px; border: 1px solid rgb(204, 204, 204); width: 594px;"><div><span style="font-size: 12pt; font-variant-caps: normal; font-variant-ligatures: normal; line-height: 26px; color: rgb(79, 79, 79); font-family: -apple-system;">在index上随机，选择index对应位置的server</span></div></td></tr><tr><td style="padding: 8px; border: 1px solid rgb(204, 204, 204); width: 203px;"><div><span style="font-size: 12pt; font-variant-caps: normal; font-variant-ligatures: normal; line-height: 26px; color: rgb(79, 79, 79); font-family: -apple-system;">ZoneAvoidanceRule</span></div></td><td style="padding: 8px; border: 1px solid rgb(204, 204, 204); width: 642px;"><div><span style="font-size: 12pt; font-variant-caps: normal; font-variant-ligatures: normal; line-height: 26px; color: rgb(79, 79, 79); font-family: -apple-system;">public class ZoneAvoidanceRule extends PredicateBasedRule</span></div></td><td style="padding: 8px; border: 1px solid rgb(204, 204, 204); width: 251px;"><span style="font-size: 16px; letter-spacing: normal; orphans: 2; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; font-variant-caps: normal; font-variant-ligatures: normal; line-height: 26px; color: rgb(79, 79, 79); font-family: -apple-system, &quot;SF UI Text&quot;, Arial, &quot;PingFang SC&quot;, &quot;Hiragino Sans GB&quot;, &quot;Microsoft YaHei&quot;, &quot;WenQuanYi Micro Hei&quot;, sans-serif, SimHei, SimSun;">复合判断server所在区域的性能和server的可用性选择server</span></td><td style="padding: 8px; border: 1px solid rgb(204, 204, 204); width: 594px;"><span style="font-size: 12pt; font-variant-caps: normal; font-variant-ligatures: normal; line-height: 26px; color: rgb(79, 79, 79); font-family: -apple-system;">使用ZoneAvoidancePredicate和AvailabilityPredicate来判断是否选择某个server，前一个判断判定一个zone的运行性能是否可用，剔除不可用的zone（的所有server），AvailabilityPredicate用于过滤掉连接数过多的Server。</span></td></tr></tbody></table><div style="font-size: 16px; margin: 0px 0px 16px; padding: 0px; box-sizing: border-box; text-align: justify; word-wrap: break-word; word-break: normal; letter-spacing: normal; orphans: 2; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px;"><span style="box-sizing: border-box; word-wrap: break-word; word-break: normal; letter-spacing: normal; orphans: 2; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px;"><span style="font-size: 12pt;"><span style="font-variant-caps: normal; font-variant-ligatures: normal; line-height: 26px; color: rgb(79, 79, 79); font-size: 12pt; font-weight: bold;">application.properties 配置文件</span></span></span></div><div style="margin: 0px 0px 16px; padding: 0px; box-sizing: border-box; text-align: justify; word-wrap: break-word; word-break: normal; letter-spacing: normal; orphans: 2; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px;"><div style="box-sizing: border-box; padding: 8px; font-family: Monaco, Menlo, Consolas, &quot;Courier New&quot;, monospace; font-size: 12px; color: rgb(51, 51, 51); border-radius: 4px; background-color: rgb(251, 250, 248); border: 1px solid rgba(0, 0, 0, 0.15);-en-codeblock:true;"><div style="color: rgb(79, 79, 79); font-size: 12pt;"><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">#<span style="color: rgb(52, 48, 45); box-sizing: border-box; font-variant-ligatures: normal; font-variant-caps: normal; letter-spacing: normal; orphans: 2; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; font-family: 微软雅黑; font-size: 10pt;">EUREKA-PRODUCER 表示本程序要调用的服务</span></span></div><div><span style="color: rgb(52, 48, 45); box-sizing: border-box; font-variant-ligatures: normal; font-variant-caps: normal; letter-spacing: normal; orphans: 2; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px;"><font style="font-size: 10pt; font-family: 微软雅黑;">EUREKA-PRODUCER</font></span><font face="Monaco" style="color: rgb(51, 51, 51); font-size: 9pt;">.</font><font color="#328712"><span style="font-size: 14px; font-family: Consolas, Inconsolata, Courier, monospace; background: rgb(246, 248, 250); box-sizing: border-box; white-space: pre; border-radius: 4px; line-height: 22px; overflow-x: auto; word-wrap: normal;">ibbon</span><span style="font-size: 14px; font-family: Consolas, Inconsolata, Courier, monospace; background: rgb(246, 248, 250); box-sizing: border-box; white-space: pre; border-radius: 4px; line-height: 22px; overflow-x: auto; word-wrap: normal;">.NFLoadBalancerRuleClassName</span><span style="font-size: 14px; font-family: Consolas, Inconsolata, Courier, monospace; background: rgb(246, 248, 250); box-sizing: border-box; white-space: pre; border-radius: 4px; line-height: 22px; overflow-x: auto; word-wrap: normal;">=</span><span style="font-size: 14px; font-family: Consolas, Inconsolata, Courier, monospace; background: rgb(246, 248, 250); box-sizing: border-box; white-space: pre; border-radius: 4px; line-height: 22px; overflow-x: auto; word-wrap: normal;">com</span><span style="font-size: 14px; font-family: Consolas, Inconsolata, Courier, monospace; background: rgb(246, 248, 250); box-sizing: border-box; white-space: pre; border-radius: 4px; line-height: 22px; overflow-x: auto; word-wrap: normal;">.netflix</span><span style="font-size: 14px; font-family: Consolas, Inconsolata, Courier, monospace; background: rgb(246, 248, 250); box-sizing: border-box; white-space: pre; border-radius: 4px; line-height: 22px; overflow-x: auto; word-wrap: normal;">.loadb</span><span style="font-size: 14px; font-family: Consolas, Inconsolata, Courier, monospace; background: rgb(246, 248, 250); box-sizing: border-box; white-space: pre; border-radius: 4px; line-height: 22px; overflow-x: auto; word-wrap: normal;">alancer</span><span style="font-size: 14px; font-family: Consolas, Inconsolata, Courier, monospace; background: rgb(246, 248, 250); box-sizing: border-box; white-space: pre; border-radius: 4px; line-height: 22px; overflow-x: auto; word-wrap: normal;">.RandomRule</span></font></div></div></div></div><div style="box-sizing: border-box; list-style: none; margin: 0px; padding: 0px 5px;"><span style="font-weight: bold; font-size: 12pt;">测试</span></div><div style="box-sizing: border-box; list-style: none; margin: 0px; padding: 0px 5px;"><br/></div><div style="box-sizing: border-box; list-style: none; margin: 0px; padding: 0px 5px;">在该程序所有访问 <span style="box-sizing: border-box; letter-spacing: normal; orphans: 2; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; font-size: 10pt; color: rgb(52, 48, 45); font-family: 微软雅黑; font-variant-caps: normal; font-variant-ligatures: normal;">EUREKA-PRODUCER 的服务时,将会采用随机负载策略</span></div></span>
</div></body></html> 